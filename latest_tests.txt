============================= test session starts =============================
platform win32 -- Python 3.10.11, pytest-9.0.2, pluggy-1.6.0 -- D:\Finished Projects\Resume\Document_validator_backend\.venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: D:\Finished Projects\Resume\Document_validator_backend
configfile: pyproject.toml
plugins: anyio-4.12.1, asyncio-1.3.0
asyncio: mode=auto, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 30 items

tests/test_edge_cases.py::test_extremely_large_text_input FAILED         [  3%]
tests/test_edge_cases.py::test_extremely_long_policy_number PASSED       [  6%]
tests/test_edge_cases.py::test_vessel_name_only_special_characters PASSED [ 10%]
tests/test_edge_cases.py::test_policy_duration_exceeds_50_years PASSED   [ 13%]
tests/test_edge_cases.py::test_date_outside_reasonable_range PASSED      [ 16%]
tests/test_edge_cases.py::test_insured_value_at_boundary PASSED          [ 20%]
tests/test_edge_cases.py::test_empty_request_text PASSED                 [ 23%]
tests/test_edge_cases.py::test_whitespace_only_text PASSED               [ 26%]
tests/test_edge_cases.py::test_multiple_spaces_in_vessel_name_normalization PASSED [ 30%]
tests/test_edge_cases.py::test_multiple_spaces_in_policy_number_normalization PASSED [ 33%]
tests/test_edge_cases.py::test_health_endpoint_error_handling PASSED     [ 36%]
tests/test_edge_cases.py::test_version_endpoint_error_handling PASSED    [ 40%]
tests/test_edge_cases.py::test_validation_endpoint_with_extraction_exception PASSED [ 43%]
tests/test_meta.py::test_health_endpoint PASSED                          [ 46%]
tests/test_meta.py::test_version_endpoint PASSED                         [ 50%]
tests/test_meta.py::test_health_endpoint_validates_types PASSED          [ 53%]
tests/test_validate_ok.py::test_validate_happy_path PASSED               [ 56%]
tests/test_validate_rules.py::test_invalid_date_order PASSED             [ 60%]
tests/test_validate_rules.py::test_invalid_insured_value FAILED          [ 63%]
tests/test_validate_rules.py::test_invalid_vessel_name PASSED            [ 66%]
tests/test_validate_rules.py::test_invalid_policy_number PASSED          [ 70%]
tests/test_validate_rules.py::test_thousand_separator_and_currency PASSED [ 73%]
tests/test_validate_rules.py::test_malformed_date PASSED                 [ 76%]
tests/test_validate_rules.py::test_vessel_name_case_insensitive PASSED   [ 80%]
tests/test_validate_rules.py::test_real_extractor_integration PASSED     [ 83%]
tests/test_validate_rules.py::test_negative_insured_value PASSED         [ 86%]
tests/test_validate_rules.py::test_all_fields_missing FAILED             [ 90%]
tests/test_validate_rules.py::test_extremely_large_insured_value FAILED  [ 93%]
tests/test_validate_rules.py::test_same_start_and_end_date PASSED        [ 96%]
tests/test_validate_rules.py::test_whitespace_in_vessel_name PASSED      [100%]

================================== FAILURES ===================================
_______________________ test_extremely_large_text_input _______________________

client = <httpx.AsyncClient object at 0x00000127BD679480>

    @pytest.mark.asyncio
    async def test_extremely_large_text_input(client: AsyncClient):
        """Test that extremely large text input is handled gracefully."""
        # Create 2MB of text (exceeds the 1MB limit in ai_extractor)
        large_text = "x" * (2 * 1024 * 1024)
    
        response = await client.post("/validate", json={"text": large_text})
    
        # Should not crash, should return a response
>       assert response.status_code == 200
E       assert 422 == 200
E        +  where 422 = <Response [422 Unprocessable Entity]>.status_code

tests\test_edge_cases.py:49: AssertionError
_________________________ test_invalid_insured_value __________________________

client = <httpx.AsyncClient object at 0x00000127BD75FA00>

    @pytest.mark.asyncio
    async def test_invalid_insured_value(client: AsyncClient):
        fields = ExtractedFields(
            policy_number="POL-001",
            vessel_name="Sea Breeze",
            policy_start_date="2024-05-01",
            policy_end_date="2024-06-01",
            insured_value="0",
        )
        app.dependency_overrides[get_default_extractor] = lambda: _MockExtractor(fields)
    
        response = await client.post("/validate", json={"text": "ignored"})
        payload = response.json()
    
        assert payload["validations"]["insured_value_ok"] is False
>       assert "insured_value (0.0) must be greater than zero" in payload["errors"]
E       AssertionError: assert 'insured_value (0.0) must be greater than zero' in ['insured_value is missing or invalid']

tests\test_validate_rules.py:73: AssertionError
------------------------------ Captured log call ------------------------------
WARNING  app.routes.validate:validate.py:136 Validation failed with 1 errors
___________________________ test_all_fields_missing ___________________________

client = <httpx.AsyncClient object at 0x00000127BE1FFA00>

    @pytest.mark.asyncio
    async def test_all_fields_missing(client: AsyncClient):
        """Test validation when all fields are missing."""
        fields = ExtractedFields()
        app.dependency_overrides[get_default_extractor] = lambda: _MockExtractor(fields)
    
        response = await client.post("/validate", json={"text": "ignored"})
        payload = response.json()
    
        assert payload["is_valid"] is False
        assert "policy_number is missing or empty" in payload["errors"]
        assert "vessel_name is missing or empty" in payload["errors"]
>       assert "policy_start_date is missing or invalid format" in payload["errors"]
E       AssertionError: assert 'policy_start_date is missing or invalid format' in ['policy_number is missing or empty', 'vessel_name is missing or empty', 'policy_start_date is missing or invalid format (YYYY-MM-DD)', 'policy_end_date is missing or invalid format (YYYY-MM-DD)', 'insured_value is missing or invalid']

tests\test_validate_rules.py:221: AssertionError
------------------------------ Captured log call ------------------------------
WARNING  app.routes.validate:validate.py:136 Validation failed with 5 errors
_____________________ test_extremely_large_insured_value ______________________

client = <httpx.AsyncClient object at 0x00000127BE1FE470>

    @pytest.mark.asyncio
    async def test_extremely_large_insured_value(client: AsyncClient):
        """Test that extremely large insured values are handled."""
        # Value larger than 1 quadrillion should be rejected
        fields = ExtractedFields(
            policy_number="POL-001",
            vessel_name="Sea Breeze",
            policy_start_date="2024-05-01",
            policy_end_date="2024-06-01",
            insured_value=str(1e16),  # 10 quadrillion
        )
        app.dependency_overrides[get_default_extractor] = lambda: _MockExtractor(fields)
    
        response = await client.post("/validate", json={"text": "ignored"})
        payload = response.json()
    
        # Should be rejected as None due to overflow protection
>       assert payload["extracted"]["insured_value"] is None
E       assert 116.0 is None

tests\test_validate_rules.py:243: AssertionError
=========================== short test summary info ===========================
FAILED tests/test_edge_cases.py::test_extremely_large_text_input - assert 422...
FAILED tests/test_validate_rules.py::test_invalid_insured_value - AssertionEr...
FAILED tests/test_validate_rules.py::test_all_fields_missing - AssertionError...
FAILED tests/test_validate_rules.py::test_extremely_large_insured_value - ass...
======================== 4 failed, 26 passed in 1.20s =========================
